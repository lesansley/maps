function viewModel(){var a=this;a.castles=castleList.sort(function(a,b){return a.name>b.name?1:-1}),a.index=ko.observable(),a.wiki=ko.observable(),a.flickr=ko.observableArray(),a.selectedCastle=ko.observable(),a.options=a.castles.map(function(a){return{label:a.name,value:a.name,object:a}})}function assignSelectedCastle(a){self.selectedCastle(a)}function findIndex(a,b){return indexes=$.map(a,function(a,c){return a.name==b?c:void 0}),indexes}function convertToLatLng(a,b){return new google.maps.LatLng(a,b)}function jsonFlickrApi(a){if("fail"!=a.stat){var b=a.photos.photo;self.flickr.removeAll();for(var c in b){var d="http://farm"+b[c].farm+".static.flickr.com/"+b[c].server+"/"+b[c].id+"_"+b[c].secret+".jpg";self.flickr.push(d)}}else console.log("FLICKR AJAX ERROR; Error Code: "+a.code+"; Error message: "+a.message)}function formatWikiArticle(a,b,c){var d="Sorry there does not seem to be an entry in Wikipedia for this castle.",e='<span class="castle-description">%description%</span><p><div><a href=%url% target="_blank">Link to Wikipedia article</a>',f='<h1 class="castle-title">%title%</h1>%entry%',g=f.replace("%title%",a);return"undefined"==typeof b?(g=g.replace("%entry%",d),g=g.replace("%url%","")):(g=g.replace("%entry%",e),g=g.replace("%description%",b),g=g.replace("%url%",c)),g}function markerSelect(a,b,c,d){var e=convertToLatLng(c,d);centerMap(e),arrMarkers[previousMarkerIndex].setIcon("images/castle-black15x15.png"),arrMarkers[a].setIcon("images/castle-red15x15.png"),loadFlickr(b,c,d),previousMarkerIndex=a}function markerMouseOver(a){infobubble.open(map,a),infobubble2.open(),infobubble.setContent(self.wiki())}function markerMouseOut(){infobubble.close(map,marker)}function centerMap(a){map.panTo(a)}function focusMarker(a){marker=new google.maps.Marker({position:a,map:map,icon:"images/castle-red15x15.png",zIndex:999}),marker.icon="images/castle-black15x15.png"}var castleList=[{name:"Warkworth Castle",lat:55.345211,lng:-1.611844},{name:"Dunstanburgh Castle",lat:55.491568,lng:-1.592444},{name:"Creswell Castle",lat:55.233493,lng:-1.540052},{name:"Halton Castle",lat:55.005216,lng:-2.005442},{name:"Wark on Tweed Castle",lat:55.64287,lng:-2.283561},{name:"Wark in Tyndale Castle",lat:55.085894,lng:-2.218507},{name:"Haltwhistle Castle",lat:54.9706,lng:-2.4515},{name:"Bellingham Castle",lat:55.1428,lng:-2.251},{name:"Dally Castle",lat:55.1533,lng:-2.3549},{name:"Chipchase Castle",lat:55.0756,lng:-2.186},{name:"Tarset Castle",lat:55.163,lng:-2.334},{name:"Ponteland Castle",lat:55.0503,lng:-1.7417},{name:"Thirlwall Castle",lat:54.989,lng:-2.532},{name:"Aydon Castle",lat:54.9904,lng:-2},{name:"Norham Castle",lat:55.722,lng:-2.149},{name:"Belsay Castle",lat:55.102,lng:-1.869},{name:"Chillingham Castle",lat:55.526,lng:-1.905},{name:"Prudhoe Castle",lat:54.9642,lng:-1.8547},{name:"Berwick Castle",lat:55.7738,lng:-2.0116},{name:"Bywell Castle",lat:54.951,lng:-1.925},{name:"Langley Castle",lat:54.956,lng:-2.259},{name:"Featherstone Castle",lat:54.943,lng:-2.51},{name:"Blenkinsopp Castle",lat:54.974,lng:-2.525},{name:"Twizell Castle",lat:55.683,lng:-2.188},{name:"Callaly Castle",lat:55.383,lng:-1.921},{name:"Morpeth Castle",lat:55.164,lng:-1.686},{name:"Haughton Castle",lat:55.05053,lng:-2.12988},{name:"Cartington Castle",lat:55.335,lng:-1.94},{name:"Coupland Castle",lat:55.574,lng:-2.103},{name:"Bamburgh Castle",lat:55.608,lng:-1.709},{name:"Ford Castle",lat:55.631,lng:-2.091},{name:"Etal Castle",lat:55.6481,lng:-2.1207},{name:"Elsdon Castle",lat:55.2356,lng:-2.0974},{name:"Edlingham Castle",lat:55.379,lng:-1.82},{name:"Mitford Castle",lat:55.164,lng:-1.734},{name:"Lindisfarne Castle",lat:55.669,lng:-1.785},{name:"Dilston Castle",lat:54.965,lng:-2.039},{name:"Alnwick Castle",lat:55.41575,lng:-1.70607},{name:"Harbottle Castle",lat:55.337,lng:-2.109},{name:"Bothal Castle",lat:55.173,lng:-1.625}],map,arrMarkers=[],previousMarkerIndex=0;ko.bindingHandlers.googlemap={init:function(a,b){var c=b(),d={zoom:10,center:convertToLatLng(c.centerLat,c.centerLng),mapTypeId:google.maps.MapTypeId.ROADMAP};map=new google.maps.Map(a,d),google.maps.event.addDomListener(window,"resize",function(){var a=map.getCenter();google.maps.event.trigger(map,"resize"),map.setCenter(a)});var e=c.castles.sort(function(a,b){return a.name>b.name?1:-1});for(var f in e){var g=convertToLatLng(e[f].lat,e[f].lng);marker=new google.maps.Marker({position:g,map:map,icon:"images/castle-black15x15.png",id:f}),google.maps.event.addListener(marker,"click",function(a){return function(){var b=a.id,c=a.position.lat(),d=a.position.lng(),e=self.castles[b];assignSelectedCastle(e),infobubble.close(map,a),markerSelect(b,e.name,c,d)}}(marker)),google.maps.event.addListener(marker,"mouseover",function(a,b){return function(){var c=e[a].name;loadWiki(c,b)}}(f,marker)),google.maps.event.addListener(marker,"mouseout",function(a){return function(b){markerMouseOut(a)}}(marker)),arrMarkers.push(marker)}}},ko.bindingHandlers.autoComplete={init:function(a,b,c,d,e){var f=b();console.log(a),self.selectedCastle=f.selected,self.options=f.options;var g=function(b,c){b.preventDefault(),null===c.item&&(c.item=""),$(a).val(c.item.label),"undefined"!=typeof c.item&&assignSelectedCastle(c.item.object)};$(a).autocomplete({source:options,delay:0,select:function(a,b){g(a,b);var c=self.selectedCastle().lat,d=self.selectedCastle().lng,e=self.selectedCastle().name,f=findIndex(self.castles,e);markerSelect(f,e,c,d)},focus:function(a,b){g(a,b)},change:function(a,b){g(a,b)}})}};var loadFlickr=function(a,b,c){var d=a.replace(/ /g,"+"),e=setTimeout(function(){alert("Flickr images could not be loaded at this time")},8e3);$.ajax({url:"https://api.flickr.com/services/rest/",data:{method:"flickr.photos.search",crossDomain:!0,api_key:"c5d5dfb581a7a72e8afd495ac82b1cde",tags:d,lat:b,lon:c,accuracy:16,safe_search:1,content_type:1,radius:2,per_page:4,format:"json"},dataType:"jsonp",success:clearTimeout(e)})},loadWiki=function(a,b){var c=(a.replace(/ /g,"%20"),setTimeout(function(){self.wiki("Wikipedia articles could not be loaded")},8e3));$.ajax({url:"https://en.wikipedia.org/w/api.php",data:{action:"opensearch",search:a,crossDomain:!0,format:"json",redirects:"resolve"},dataType:"jsonp",success:function(a){var d=a[0],e=a[2][0],f=a[3][0],g=formatWikiArticle(d,e,f);self.wiki(g),markerMouseOver(b),clearTimeout(c)}})},infobubble=new InfoBubble({maxWidth:300,hideCloseButton:!0}),infobubble2=new InfoBubble;ko.applyBindings(viewModel);